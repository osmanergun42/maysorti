<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <title>Kayıtlı Tablolar</title>
  <link rel="stylesheet" href="styles.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
</head>
<body>

<div class="header-container">
  <h2>Kayıtlı Tablolar</h2>
  <div class="button-container">
    <input type="date" id="search-date">
    <button onclick="loadData()">Verileri Getir</button>
    <button onclick="downloadPDF()">PDF İndir</button>
  </div>
</div>

<div id="tables-container"></div>

<script>
  function loadData() {
    const date = document.getElementById('search-date').value;
    if (!date) {
      alert('Lütfen bir tarih girin.');
      return;
    }

    const storedData = JSON.parse(localStorage.getItem('tables') || '{}')[date];
    const tablesContainer = document.getElementById('tables-container');
    tablesContainer.innerHTML = '';

    if (storedData) {
      const table = document.createElement('table');
      table.style.width = "100%";
      table.border = "1";
      
      const thead = document.createElement('thead');
      const tbody = document.createElement('tbody');

      const headerRow1 = document.createElement('tr');
      const headerRow2 = document.createElement('tr');
      headerRow1.innerHTML = `
        <th rowspan="2">#</th>
        <th colspan="4">Toroman</th>
        <th colspan="4">Küçük</th>
        <th colspan="4">Keş</th>
        <th colspan="4">Çete</th>
      `;
      headerRow2.innerHTML = `
        <th>Giriş</th><th>Çıkış</th><th>Ürün</th><th>Kg</th>
        <th>Giriş</th><th>Çıkış</th><th>Ürün</th><th>Kg</th>
        <th>Giriş</th><th>Çıkış</th><th>Ürün</th><th>Kg</th>
        <th>Giriş</th><th>Çıkış</th><th>Ürün</th><th>Kg</th>
      `;

      thead.appendChild(headerRow1);
      thead.appendChild(headerRow2);

      storedData.forEach((row, rowIndex) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${rowIndex + 1}</td>`;
        row.forEach(cell => {
          const td = document.createElement('td');
          td.textContent = cell;
          tr.appendChild(td);
        });
        tbody.appendChild(tr);
      });

      table.appendChild(thead);
      table.appendChild(tbody);
      tablesContainer.appendChild(table);
    } else {
      tablesContainer.innerHTML = '<p>Bu tarihte kayıtlı veri yok.</p>';
    }
  }

  function downloadPDF() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF('p', 'mm', 'a4');
    const elementHTML = document.getElementById('tables-container');

    // Tarihi Al ve Formatla
    const dateInput = document.getElementById('search-date').value;
    if (!dateInput) {
      alert("Lütfen önce bir tarih seçin!");
      return;
    }
    const formattedDate = formatDate(dateInput);

    // **Türkçe Karakter Sorununu Çözmek için Font Ayarlıyoruz**
    doc.setFont("times", "normal");

    // PDF Başlık ve Tarih Yazdır
    doc.setFontSize(16);
    doc.text("Kayıtlı Tablolar", 10, 20);
    
    doc.setFontSize(12);
    doc.text(`Tarih: ${formattedDate}`, 10, 30);

    html2canvas(elementHTML, { scale: 2 }).then((canvas) => {
      const imgData = canvas.toDataURL('image/png');
      const imgWidth = 190;
      const imgHeight = (canvas.height * imgWidth) / canvas.width;
      let position = 40;

      doc.addImage(imgData, 'PNG', 10, position, imgWidth, imgHeight);
      doc.save(`Tablo_${formattedDate}.pdf`);
    }).catch(error => {
      console.error('PDF oluşturulurken hata oluştu:', error);
    });
  }

  function formatDate(dateString) {
    const months = [
      "Ocak", "Şubat", "Mart", "Nisan", "Mayıs", "Haziran",
      "Temmuz", "Ağustos", "Eylül", "Ekim", "Kasım", "Aralık"
    ];
    const date = new Date(dateString);
    return `${date.getDate()} ${months[date.getMonth()]} ${date.getFullYear()}`;
  }
</script>

</body>
</html>
